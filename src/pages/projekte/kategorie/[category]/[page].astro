---
import { getCollection } from 'astro:content'
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'
import ProjectsLayout from '@/layouts/ProjectsLayout.astro'

export const getStaticPaths = (async ({ paginate }) => {
  const allProjects = (await getCollection('projekte'))
    .filter(project => !project.data.draft)
    .sort((a, b) => {
      // Featured projects first
      if (a.data.featured && !b.data.featured) return -1
      if (!a.data.featured && b.data.featured) return 1
      // Then sort by date
      return b.data.date.getTime() - a.data.date.getTime()
    })

  // Get all unique categories
  const categories = [...new Set(allProjects.flatMap(project => project.data.category || []))]

  // Create paginated routes for each category
  return categories.flatMap(category => {
    const filteredProjects = allProjects.filter(project =>
      project.data.category?.includes(category)
    )
    return paginate(filteredProjects, {
      params: { category },
      pageSize: 5
    })
  })
}) satisfies GetStaticPaths

type Props = {
  page: Page<CollectionEntry<'projekte'>>
}

const { page } = Astro.props
const projects = page.data
const title = `in der Kategorie ${Astro.params.category}`
---

<ProjectsLayout projects={projects} page={page} title={title} />
